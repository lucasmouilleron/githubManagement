githubManagement
================

Features
--------
- Github projects management and processing
- Relies on Github user roles and access rights
- Small API to create tags on master, respond to Githib hooks, etc.
- Processors : per project configuration of standard or custom processors list to run against a tag hook
- Miscs : loging

Architecture
------------
- `processors` : the processors
- `configs` : projects config files
- `locals` : projects locals files
- `repos-clones` : temporary repos clones (clones for building then copying to `web`)
- `api` : the public API
- `locks`: the locks folder

Triggering
----------
- Tag name syntax : `.*--deploy-ENV.*`
- ENVS are defined in `$PROCESSOR_AVAILABLE_ENVS` in `api/config.php`
- Wheter the tag is created from the API or from a local repo (and then pushed), the processing will be triggered

Processors
----------
### Main
- The main processor, always called first

### Lock
- Forbids concurrent processings untill the current one is finished
- Auto released when the processing is finished

### Clone
- Clones (or pull + reset) the repo to the `repos-clones` folder

### Locals
- Copies project local files from `locals/owner/repo/ENV` to `repos-clones/owner/repo/$localsPath`
- Convenient if some parameters are diffrent from one env to the other
- In this case, isolate these parameters in some files which are copied depending on what ENV is targeted

### Build
- Runs a build file for the project
- The build file is an executable script or app

### Deploy-files
- Sends the files to the remove env ENV
- The `$deployFolder` is sent to the `$envBasePath`

### Deploy-db
- Sends and runs the DB on the remote env ENV
- For flexibility reason, the string `--db` must be included in the tag name for the processor to run

API
---
### Overview
- Most API calls require a Github user access token : https://github.com/settings/applications#personal-access-tokens
- `GITHUB_MASTER_TOKEN` user must have access to all repos

### Routes
- Create a tag :
	- `POST /repos/:owner/:repo/tag` :
	- post params : tag-revision, tag-name, tag-message
	- get param : github-token (the github token of the user)
	- example : `Requests::post(API_URL."/repos/lucasmouilleron/testDeploy/tag?github-token=THE_USER_TOKEN", array(), array("tag-revision"=>$revision,"tag-name"=>"tag".time(),"tag-message"=>"message !"))`;
- Init deployments : 
	- `POST /repos/:owner/:repo/hook/init`
	- post params : none
	- get param : github-token (the github token of the user) (use `GITHUB_MASTER_TOKEN` if called from PHP for administration purpose)
	- example : `Requests::post(API_URL."/repos/lucasmouilleron/testDeploy/hook/init?github-token=".GITHUB_MASTER_TOKEN);`
- Github hook : 
	- `POST /repos/:owner/:repo/hook/:token`
	- called by github on tag create
	- `token` is generated by us and is used for security purpose

Notes
-----
- Not yet compatible with Github entreprise
- Deployment is purposly simple. Other methods could involve branching and pushing tags to specific branches.

Install requirements
--------------------
- `curl -sS https://getcomposer.org/installer | php`
- `mv composer.phar /usr/local/bin/composer`

Install
-------
- `cd api && composer install`
- `mv api/config.php.sample api/config.php`
- edit the `api/config.php` file :
	- change `API_PRIVATE_KEY` to a random string
	- `API_URL` is where your api is publicly http available

TODO
----
- log cleanup